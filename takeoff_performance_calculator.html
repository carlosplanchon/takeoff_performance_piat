<!DOCTYPE html>
<html lang="es" x-data="takeoffCalculator()" x-bind:lang="lang">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title x-text="t('page_title')"></title>
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- AlpineJS CDN -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        body { scroll-behavior: smooth; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #2563eb; cursor: pointer; border-radius: 50%; margin-top: -6px; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: #2563eb; cursor: pointer; border-radius: 50%; }
        .runway-centerline { background-image: repeating-linear-gradient(90deg, white, white 20px, transparent 20px, transparent 40px); }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

    <div class="container mx-auto p-4 md:p-8" x-init="init()">
        
        <!-- Language Switcher -->
        <div class="flex justify-end mb-4">
            <div class="flex space-x-1 rounded-lg bg-gray-200 p-1">
                <button @click="setLang('es')" :class="lang === 'es' ? 'bg-white text-blue-600 shadow' : 'text-gray-600'" class="px-3 py-1 text-sm font-semibold rounded-md transition-colors">ES</button>
                <button @click="setLang('en')" :class="lang === 'en' ? 'bg-white text-blue-600 shadow' : 'text-gray-600'" class="px-3 py-1 text-sm font-semibold rounded-md transition-colors">EN</button>
            </div>
        </div>
        
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900" x-text="t('main_title')"></h1>
            <p class="text-xl text-gray-600 mt-1" x-text="t('subtitle')"></p>
        </div>

        <!-- SECCIÓN DE GRÁFICO -->
        <div class="mt-8 bg-white p-6 rounded-xl shadow-lg">
            <div x-show="results.obstacle > runwayLength_m" class="mb-6 bg-red-100 border-l-8 border-red-500 text-red-800 p-4 rounded-lg" role="alert" x-cloak>
                <p class="text-xl font-bold" x-text="t('danger_short_runway_title')"></p>
                <p x-html="t('danger_short_runway_desc', { 
                    req: `<span class='font-bold'>${units === 'metric' ? results.obstacle.toFixed(0) + ' m' : (results.obstacle / 0.3048).toFixed(0) + ' ft'}</span>`, 
                    avail: `<span class='font-bold'>${units === 'metric' ? runwayLength_m.toFixed(0) + ' m' : (runwayLength_m / 0.3048).toFixed(0) + ' ft'}</span>` 
                })"></p>
            </div>
            <h2 class="text-2xl font-bold mb-2 text-center" x-text="t('graphic_title')"></h2>
            <div class="relative w-full h-32 flex items-center pt-8">
                <!-- Pista -->
                <div class="relative w-full h-16 bg-gray-600 rounded-lg shadow-inner flex items-center justify-center"><div class="w-full h-1 bg-gray-800 absolute top-1/2 -translate-y-1/2"></div><div class="w-full h-1 runway-centerline absolute top-1/2 -translate-y-1/2"></div></div>
                <div class="absolute h-full top-8 left-0 text-center font-bold"><div class="h-16 flex items-center">|</div></div>
                <!-- Marcador de Fin de Pista -->
                <div class="absolute h-full top-8 text-center" :style="{ left: graphic.runwayEndPercent + '%' }"><div class="h-16 flex items-center text-red-500 font-extrabold text-2xl">|</div><p class="absolute -bottom-5 text-xs font-bold text-red-600 transform -translate-x-1/2 whitespace-nowrap" x-text="t('runway_end_label')"></p></div>
                <!-- Marcador de Carrera de Despegue -->
                <div class="absolute h-full top-8" :style="{ left: graphic.groundRollPercent + '%' }"><div class="absolute bottom-1/2 h-10 w-px bg-cyan-400"></div><div class="absolute top-1/2 transform -translate-x-1/2 bg-cyan-500 text-white text-xs font-bold p-1 rounded-md shadow-lg whitespace-nowrap z-10"><p x-text="t('liftoff_label')"></p><span x-text="units === 'metric' ? results.groundRoll.toFixed(0) + ' m' : (results.groundRoll / 0.3048).toFixed(0) + ' ft'"></span></div></div>
                <!-- Avión en punto de Liftoff -->
                <div class="absolute bottom-1/2 mb-1 transition-all duration-200 ease-linear z-20" :style="{ left: graphic.groundRollPercent + '%' }"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-fuchsia-500 transform -translate-x-1/2 -rotate-90" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg></div>
                <!-- Marcador de Obstáculo -->
                <div class="absolute h-full top-8 transition-all duration-200 ease-linear" :style="{ left: graphic.obstaclePercent + '%' }"><div class="absolute top-1/2 h-10 w-px bg-green-400"></div><div class="absolute bottom-1/2 transform -translate-x-1/2 bg-green-600 text-white text-xs font-bold p-1 rounded-md shadow-lg whitespace-nowrap z-10"><p x-text="t('obstacle_label')"></p><span x-text="units === 'metric' ? results.obstacle.toFixed(0) + ' m' : (results.obstacle / 0.3048).toFixed(0) + ' ft'"></span></div><div class="absolute top-1/2 -mt-7 transform -translate-x-1/2"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v1.333A3.001 3.001 0 0114 8v1.333a3.001 3.001 0 01-3 3v1.333a3.001 3.001 0 01-3-3V8a3.001 3.001 0 013-3.333V4a1 1 0 011-1zm-5.5 8.243a3.002 3.002 0 012.336-2.525l.002-.001.002-.001a3.002 3.002 0 012.336 2.525V15a1 1 0 11-2 0v-.5H7.834V15a1 1 0 11-2 0v-1.757zM15.5 11.243a3.002 3.002 0 012.336-2.525l.002-.001.002-.001a3.002 3.002 0 012.336 2.525V15a1 1 0 11-2 0v-.5h-.166V15a1 1 0 11-2 0v-1.757z" clip-rule="evenodd" /></svg></div></div>
            </div>
            <!-- Regla de Escala -->
            <div class="relative w-full h-8 mt-1 border-t border-gray-300">
                <template x-for="tick in graphic.rulerTicks" :key="tick.label">
                    <div class="absolute h-full" :style="{ left: tick.positionPercent + '%' }">
                        <div class="h-2 w-px bg-gray-400"></div>
                        <span class="absolute text-xs text-gray-500 transform -translate-x-1/2" x-text="tick.label"></span>
                    </div>
                </template>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-8">

            <!-- Columna de Entradas -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 border-b pb-3" x-text="t('inputs_title')"></h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                    <div class="mb-6 md:col-span-2"><label class="block font-semibold mb-2" x-text="t('units_label_long')"></label><div class="flex space-x-2"><button @click="units = 'metric'" :class="{'bg-blue-600 text-white': units === 'metric', 'bg-gray-200': units !== 'metric'}" class="flex-1 py-2 px-4 rounded-lg transition" x-text="t('metric_button')"></button><button @click="units = 'imperial'" :class="{'bg-blue-600 text-white': units === 'imperial', 'bg-gray-200': units !== 'imperial'}" class="flex-1 py-2 px-4 rounded-lg transition" x-text="t('imperial_button')"></button></div></div>
                    <div class="mb-6 md:col-span-2"><label for="runwayLength" class="block font-semibold mb-2" x-text="t('runway_length_label_long')"></label><div class="flex items-center"><input type="number" id="runwayLength" x-model.number="runwayLength" class="w-full p-2 border border-gray-300 rounded-md"><span class="ml-2 font-semibold text-gray-600" x-text="units === 'metric' ? 'm' : 'ft'"></span></div></div>
                </div>
                
                <div class="mb-6">
                    <label class="block font-semibold mb-2" x-text="t('elevation_label')"></label>
                    <input type="range" x-model.number="elevation_ft" min="0" max="5000" step="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex items-center justify-center mt-2 space-x-2">
                        <input type="number" x-model.number="elevation_display" class="w-24 p-1 text-center font-medium border border-gray-300 rounded-md">
                        <span class="font-semibold text-gray-600 w-4" x-text="units === 'metric' ? 'm' : 'ft'"></span>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block font-semibold mb-2" x-text="t('temperature_label')"></label>
                    <input type="range" x-model.number="temperature_c" min="-10" max="45" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex items-center justify-center mt-2 space-x-2">
                        <input type="number" x-model.number="temperature_display" class="w-24 p-1 text-center font-medium border border-gray-300 rounded-md">
                        <span class="font-semibold text-gray-600 w-4" x-text="units === 'metric' ? '°C' : '°F'"></span>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block font-semibold mb-2" x-text="t('wind_label')"></label>
                    <input type="range" x-model.number="wind_kts" min="-6" max="12" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <div class="text-center mt-2 text-lg font-medium"><span x-show="wind_kts > 0" x-text="t('wind_headwind', {speed: wind_kts})"></span><span x-show="wind_kts < 0" x-text="t('wind_tailwind', {speed: Math.abs(wind_kts)})"></span><span x-show="wind_kts == 0" x-text="t('wind_calm')"></span></div>
                    <div class="flex items-center justify-center mt-2 space-x-2">
                        <input type="number" x-model.number="wind_kts" min="-6" max="12" step="1" class="w-24 p-1 text-center font-medium border border-gray-300 rounded-md">
                        <span class="font-semibold text-gray-600 w-8">kts</span>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block font-semibold mb-2" x-text="t('crosswind_label')"></label>
                    <input type="range" x-model.number="crosswind_kts" min="0" max="20" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    <div class="flex items-center justify-center mt-2 space-x-2">
                        <input type="number" x-model.number="crosswind_kts" min="0" max="20" step="1" class="w-24 p-1 text-center font-medium border border-gray-300 rounded-md">
                         <span class="font-semibold text-gray-600 w-8">kts</span>
                    </div>
                </div>
                
                <div><label class="block font-semibold mb-2" x-text="t('surface_label')"></label><div class="flex space-x-2"><button @click="runwaySurface = 'paved'" :class="{'bg-blue-600 text-white': runwaySurface === 'paved', 'bg-gray-200': runwaySurface !== 'paved'}" class="flex-1 py-2 px-4 rounded-lg transition" x-text="t('surface_paved')"></button><button @click="runwaySurface = 'grass'" :class="{'bg-blue-600 text-white': runwaySurface === 'grass', 'bg-gray-200': runwaySurface !== 'grass'}" class="flex-1 py-2 px-4 rounded-lg transition" x-text="t('surface_grass')"></button></div></div>
            </div>

            <!-- Columna de Resultados -->
            <div class="bg-blue-50 p-6 rounded-xl shadow-lg border-2 border-blue-200">
                <h2 class="text-2xl font-bold mb-6 text-blue-900 border-b-2 border-blue-200 pb-3" x-text="t('results_title')"></h2>
                <div class="space-y-6"><div class="bg-white p-4 rounded-lg"><p class="text-lg font-semibold text-gray-700" x-text="t('ground_roll_label')"></p><div class="flex justify-end items-baseline space-x-2 mt-1"><span class="text-5xl font-bold text-blue-700" x-text="units === 'metric' ? results.groundRoll.toFixed(0) : (results.groundRoll / 0.3048).toFixed(0)"></span><span class="text-2xl text-gray-500" x-text="units === 'metric' ? 'm' : 'ft'"></span></div></div><div class="bg-white p-4 rounded-lg"><p class="text-lg font-semibold text-gray-700" x-text="t('obstacle_dist_label')"></p><div class="flex justify-end items-baseline space-x-2 mt-1"><span class="text-5xl font-bold text-blue-700" x-text="units === 'metric' ? results.obstacle.toFixed(0) : (results.obstacle / 0.3048).toFixed(0)"></span><span class="text-2xl text-gray-500" x-text="units === 'metric' ? 'm' : 'ft'"></span></div></div></div>
                <div class="mt-8 space-y-3"><div x-show="crosswind_kts > 18" class="bg-red-100 border-l-4 border-red-500 text-red-800 p-4 rounded" role="alert" x-cloak"><p class="font-bold" x-text="t('warning_title')"></p><p x-text="t('crosswind_warning', {speed: crosswind_kts})"></p></div></div>
            </div>
        </div>

        <!-- SECCIÓN DE DESGLOSE DEL CÁLCULO -->
        <div class="mt-8 bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4 text-center" x-text="t('breakdown_title')"></h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 text-sm">
                <!-- Columna Carrera de Despegue -->
                <div>
                    <h3 class="font-bold text-lg text-center border-b pb-2 mb-2" x-text="t('ground_roll_label')"></h3>
                    <div class="space-y-1">
                        <div class="flex justify-between"><span class="text-gray-600" x-text="t('breakdown_base_dist')"></span> <span x-text="format(breakdown.base_Lo_groundRoll)"></span></div>
                        <div class="flex justify-between"><span class="text-gray-600" x-text="t('breakdown_temp_dist')"></span> <span x-text="format(breakdown.tempEffect_Lt_groundRoll)"></span></div>
                        <div class="flex justify-between"><span class="text-gray-600" x-text="t('breakdown_elev_dist')"></span> <span x-text="format(breakdown.elevationEffect_Lh_groundRoll)"></span></div>
                        <div class="flex justify-between border-t pt-1 mt-1"><span class="font-semibold" x-text="t('breakdown_subtotal1')"></span> <span class="font-semibold" x-text="format(breakdown.elevationEffect_Lh_groundRoll + breakdown.tempEffect_Lt_groundRoll - breakdown.base_Lo_groundRoll)"></span></div>
                        <div class="flex justify-between" :class="breakdown.safetyMargin > 1 ? 'text-orange-600' : 'text-gray-600'"><span class="text-gray-600" x-text="t('safety_margin')"></span> <span x-text="breakdown.safetyMargin.toFixed(2) + 'x'"></span></div>
                        <div class="flex justify-between border-t pt-1 mt-1"><span class="font-semibold" x-text="t('breakdown_subtotal_density')"></span> <span class="font-semibold" x-text="format(breakdown.subtotal_density_groundRoll)"></span></div>
                        <div class="flex justify-between" :class="breakdown.windFactor_m === 0 ? 'text-gray-600' : breakdown.windFactor_m < 0 ? 'text-green-600' : 'text-red-600'"><span class="text-gray-600" x-text="t('breakdown_wind_adj')"></span> <span x-text="format(breakdown.windFactor_m)"></span></div>
                        <div class="flex justify-between" :class="breakdown.surfaceFactor > 1 ? 'text-orange-600' : 'text-gray-600'"><span class="text-gray-600" x-text="t('breakdown_surface_factor')"></span> <span x-text="breakdown.surfaceFactor.toFixed(2) + 'x'"></span></div>
                        <div class="flex justify-between" :class="breakdown.crosswindFactor > 1 ? 'text-orange-600' : 'text-gray-600'"><span class="text-gray-600" x-text="t('breakdown_crosswind_factor')"></span> <span x-text="breakdown.crosswindFactor.toFixed(2) + 'x'"></span></div>
                        <div class="flex justify-between text-base font-bold border-t-2 border-black pt-1 mt-2"><span x-text="t('breakdown_total')"></span> <span x-text="format(results.groundRoll)"></span></div>
                    </div>
                </div>
                <!-- Columna Distancia de Obstáculo -->
                <div>
                    <h3 class="font-bold text-lg text-center border-b pb-2 mb-2" x-text="t('obstacle_dist_label')"></h3>
                     <div class="space-y-1">
                        <div class="flex justify-between"><span class="text-gray-600" x-text="t('breakdown_base_dist')"></span> <span x-text="format(breakdown.base_Lo_obstacle)"></span></div>
                        <div class="flex justify-between"><span class="text-gray-600" x-text="t('breakdown_temp_dist')"></span> <span x-text="format(breakdown.tempEffect_Lt_obstacle)"></span></div>
                        <div class="flex justify-between"><span class="text-gray-600" x-text="t('breakdown_elev_dist')"></span> <span x-text="format(breakdown.elevationEffect_Lh_obstacle)"></span></div>
                        <div class="flex justify-between border-t pt-1 mt-1"><span class="font-semibold" x-text="t('breakdown_subtotal1')"></span> <span class="font-semibold" x-text="format(breakdown.elevationEffect_Lh_obstacle + breakdown.tempEffect_Lt_obstacle - breakdown.base_Lo_obstacle)"></span></div>
                        <div class="flex justify-between" :class="breakdown.safetyMargin > 1 ? 'text-orange-600' : 'text-gray-600'"><span class="text-gray-600" x-text="t('safety_margin')"></span> <span x-text="breakdown.safetyMargin.toFixed(2) + 'x'"></span></div>
                        <div class="flex justify-between border-t pt-1 mt-1"><span class="font-semibold" x-text="t('breakdown_subtotal_density')"></span> <span class="font-semibold" x-text="format(breakdown.subtotal_density_obstacle)"></span></div>
                        <div class="flex justify-between" :class="breakdown.windFactor_m === 0 ? 'text-gray-600' : breakdown.windFactor_m < 0 ? 'text-green-600' : 'text-red-600'"><span class="text-gray-600" x-text="t('breakdown_wind_adj')"></span> <span x-text="format(breakdown.windFactor_m)"></span></div>
                        <div class="flex justify-between" :class="breakdown.surfaceFactor > 1 ? 'text-orange-600' : 'text-gray-600'"><span class="text-gray-600" x-text="t('breakdown_surface_factor')"></span> <span x-text="breakdown.surfaceFactor.toFixed(2) + 'x'"></span></div>
                        <div class="flex justify-between" :class="breakdown.crosswindFactor > 1 ? 'text-orange-600' : 'text-gray-600'"><span class="text-gray-600" x-text="t('breakdown_crosswind_factor')"></span> <span x-text="breakdown.crosswindFactor.toFixed(2) + 'x'"></span></div>
                        <div class="flex justify-between text-base font-bold border-t-2 border-black pt-1 mt-2"><span x-text="t('breakdown_total')"></span> <span x-text="format(results.obstacle)"></span></div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="text-center mt-8 text-sm text-gray-500">
            <p x-text="t('footer_disclaimer1')"></p>
            <p x-text="t('footer_disclaimer2')"></p>
            <p x-text="t('footer_copyright')"></p>
            <p x-text="t('footer_hosting')"></p>
        </footer>
    </div>

    <script>
        function takeoffCalculator() {
            return {
                // --- TRANSLATIONS (i18n) ---
                lang: 'es', // Default language
                translations: {
                    es: {
                        page_title: 'Calculadora de Performance de Despegue - Pipistrel ALPHA Trainer LSA',
                        main_title: 'Calculadora de Performance de Despegue',
                        subtitle: 'Pipistrel ALPHA Trainer LSA',
                        danger_short_runway_title: '¡PELIGRO! PISTA CORTA',
                        danger_short_runway_desc: 'La distancia requerida ({req}) es MAYOR que la pista disponible ({avail}).',
                        graphic_title: 'Representación Gráfica',
                        runway_end_label: 'Fin Pista',
                        liftoff_label: 'Despegue',
                        obstacle_label: 'Obstáculo (50ft)',
                        inputs_title: 'Condiciones de Despegue',
                        units_label_long: 'Unidades',
                        metric_button: 'Métrico (m, °C, kts)',
                        imperial_button: 'Imperial (ft, °F, kts)',
                        runway_length_label_long: 'Longitud de Pista Disponible',
                        elevation_label: 'Elevación de Pista',
                        temperature_label: 'Temperatura Exterior',
                        wind_label: 'Viento (paralelo a eje de pista)',
                        wind_headwind: 'Viento de frente de {speed} kts',
                        wind_tailwind: 'Viento de cola de {speed} kts',
                        wind_calm: 'Calma',
                        crosswind_label: 'Viento Cruzado (perpendicular a eje de pista)',
                        surface_label: 'Superficie de Pista',
                        surface_paved: 'Asfaltada / Seca',
                        surface_grass: 'Pasto / Blanda',
                        results_title: 'Distancias de Despegue Calculadas',
                        ground_roll_label: 'Carrera de Despegue (Ground Roll)',
                        obstacle_dist_label: 'Distancia obstáculo 50 ft / 15 m',
                        warning_title: '¡ADVERTENCIA!',
                        crosswind_warning: 'El viento cruzado ({speed} kts) excede el máximo demostrado de 18 kts.',
                        breakdown_title: 'Desglose del Cálculo',
                        breakdown_base_dist: 'Distancia Base (Lo) a 15°C, SL:',
                        breakdown_temp_dist: 'Distancia por Temperatura (Lt) a SL:',
                        breakdown_elev_dist: 'Distancia por Elevación (Lh) a 15°C:',
                        breakdown_subtotal1: 'Subtotal (Lh + Lt - Lo):',
                        safety_margin: 'x Márgen de Seguridad:',
                        breakdown_subtotal_density: 'Subtotal por Densidad:',
                        breakdown_wind_adj: '+ Ajuste por Viento:',
                        breakdown_surface_factor: 'x Factor Superficie:',
                        breakdown_crosswind_factor: 'x Factor Viento Cruzado:',
                        breakdown_total: 'TOTAL REQUERIDO:',
                        footer_disclaimer1: 'Esta calculadora es una herramienta de demostración basada en el POH del Pipistrel ALPHA Trainer LSA. No debe usarse para planificación de vuelo real.',
                        footer_disclaimer2: 'Consulte siempre el Manual de Operación del Piloto (POH) oficial de su avión.',
                        footer_copyright: 'Copyright © 2025 Carlos A. Planchón - Código bajo licencia MIT.',
                        footer_hosting: 'Hosteado on-premise en Dolores, Soriano, Uruguay ♥️.'
                    },
                    en: {
                        page_title: 'Takeoff Performance Calculator - Pipistrel ALPHA Trainer LSA',
                        main_title: 'Takeoff Performance Calculator',
                        subtitle: 'Pipistrel ALPHA Trainer LSA',
                        danger_short_runway_title: 'DANGER! SHORT RUNWAY',
                        danger_short_runway_desc: 'Required distance ({req}) is GREATER than available runway ({avail}).',
                        graphic_title: 'Graphical Representation',
                        runway_end_label: 'Runway End',
                        liftoff_label: 'Liftoff',
                        obstacle_label: 'Obstacle (50ft)',
                        inputs_title: 'Takeoff Conditions',
                        units_label_long: 'Units',
                        metric_button: 'Metric (m, °C, kts)',
                        imperial_button: 'Imperial (ft, °F, kts)',
                        runway_length_label_long: 'Available Runway Length',
                        elevation_label: 'Runway Elevation',
                        temperature_label: 'Outside Air Temperature',
                        wind_label: 'Wind (parallel to runway)',
                        wind_headwind: '{speed} kts headwind',
                        wind_tailwind: '{speed} kts tailwind',
                        wind_calm: 'Calm',
                        crosswind_label: 'Crosswind (perpendicular to runway)',
                        surface_label: 'Runway Surface',
                        surface_paved: 'Paved / Dry',
                        surface_grass: 'Grass / Soft',
                        results_title: 'Calculated Takeoff Distances',
                        ground_roll_label: 'Ground Roll',
                        obstacle_dist_label: '50 ft / 15 m Obstacle Distance',
                        warning_title: 'WARNING!',
                        crosswind_warning: 'Crosswind ({speed} kts) exceeds the demonstrated maximum of 18 kts.',
                        breakdown_title: 'Calculation Breakdown',
                        breakdown_base_dist: 'Base Distance (Lo) at 15°C, SL:',
                        breakdown_temp_dist: 'Distance for Temperature (Lt) at SL:',
                        breakdown_elev_dist: 'Distance for Elevation (Lh) at 15°C:',
                        breakdown_subtotal1: 'Subtotal (Lh + Lt - Lo):',
                        safety_margin: 'x Safety Margin:',
                        breakdown_subtotal_density: 'Subtotal for Density:',
                        breakdown_wind_adj: '+ Wind Adjustment:',
                        breakdown_surface_factor: 'x Surface Factor:',
                        breakdown_crosswind_factor: 'x Crosswind Factor:',
                        breakdown_total: 'TOTAL REQUIRED:',
                        footer_disclaimer1: 'This calculator is a demonstration tool based on the Pipistrel ALPHA Trainer LSA POH. It should not be used for actual flight planning.',
                        footer_disclaimer2: 'Always consult the official Pilot\'s Operating Handbook (POH) for your aircraft.',
                        footer_copyright: 'Copyright © 2025 Carlos A. Planchón - Code under MIT license.',
                        footer_hosting: 'Hosted on-premise in Dolores, Soriano, Uruguay ♥️.'
                    }
                },

                // --- INPUTS & STATE ---
                units: 'metric',
                runwayLength_m: 1235,
                elevation_ft: 0,
                temperature_c: 15,
                wind_kts: 0,
                crosswind_kts: 0,
                runwaySurface: 'grass',
                get runwayLength() { return this.units === 'metric' ? parseFloat(this.runwayLength_m.toFixed(0)) : parseFloat((this.runwayLength_m / 0.3048).toFixed(0)); },
                set runwayLength(value) { this.runwayLength_m = this.units === 'metric' ? value : value * 0.3048; },

                // Getter/Setters for display values with unit conversion ---
                get elevation_display() {
                    return this.units === 'metric' ? Math.round(this.elevation_ft * 0.3048) : this.elevation_ft;
                },
                set elevation_display(value) {
                    this.elevation_ft = this.units === 'metric' ? value / 0.3048 : value;
                },
                get temperature_display() {
                    return this.units === 'metric' ? this.temperature_c : Math.round(this.temperature_c * 9/5 + 32);
                },
                set temperature_display(value) {
                    this.temperature_c = this.units === 'metric' ? value : (value - 32) * 5/9;
                },

                // --- RESULTS ---
                results: { groundRoll: 0, obstacle: 0 },
                graphic: { groundRollPercent: 0, obstaclePercent: 0, runwayEndPercent: 0, rulerTicks: [] },
                breakdown: {
                    base_Lo_groundRoll: 0, base_Lo_obstacle: 0,
                    tempEffect_Lt_groundRoll: 0, tempEffect_Lt_obstacle: 0,
                    elevationEffect_Lh_groundRoll: 0, elevationEffect_Lh_obstacle: 0,
                    subtotal_density_groundRoll: 0, subtotal_density_obstacle: 0,
                    safetyMargin: 1.10,
                    windFactor_m: 0,
                    surfaceFactor: 1.0,
                    crosswindFactor: 1.0,
                },

                // --- POH DATA (all in meters) ---
                base_lo: { groundRoll: 170, obstacle: 265 },
                elevationData: [ [0, 170, 265], [500, 213, 316], [1000, 265, 395], [1500, 332, 433] ],
                tempData: [ [0, 140, 240], [10, 150, 255], [15, 170, 265], [20, 205, 295], [25, 250, 320], [30, 285, 390], [35, 310, 430], [40, 317, 455], [45, 338, 500] ],

                // --- METHODS ---
                init() {
                    // Set initial language based on browser preference
                    this.lang = navigator.language.startsWith('es') ? 'es' : 'en';

                    ['units', 'runwayLength_m', 'elevation_ft', 'temperature_c', 'wind_kts', 'crosswind_kts', 'runwaySurface'].forEach(prop => {
                        this.$watch(prop, () => this.calculate());
                    });
                    this.calculate();
                },
                // Translation helper function
                t(key, replacements = {}) {
                    let text = this.translations[this.lang]?.[key] || key;
                    for (const placeholder in replacements) {
                        text = text.replace(`{${placeholder}}`, replacements[placeholder]);
                    }
                    return text;
                },
                setLang(newLang) {
                    this.lang = newLang;
                    // Recalculate to update any language-dependent parts if necessary
                    this.calculate(); 
                },
                interpolate(x, data, valueIndex) {
                    if (x <= data[0][0]) return data[0][valueIndex];
                    if (x >= data[data.length - 1][0]) return data[data.length - 1][valueIndex];
                    let p1 = null, p2 = null;
                    for (let i = 1; i < data.length; i++) { if (data[i][0] >= x) { p2 = data[i]; p1 = data[i - 1]; break; } }
                    const [x1, y1] = [p1[0], p1[valueIndex]]; const [x2, y2] = [p2[0], p2[valueIndex]];
                    if (x1 === x2) return y1;
                    return y1 + (x - x1) * (y2 - y1) / (x2 - x1);
                },
                calculate() {
                    console.log('--- Calculating take‑off performance ---');

                    // 1) Base (ISA‑sea‑level) figures
                    this.breakdown.base_Lo_groundRoll = this.base_lo.groundRoll;
                    this.breakdown.base_Lo_obstacle   = this.base_lo.obstacle;
                    console.log(`Base ground‑roll (Lo): ${this.base_lo.groundRoll} m`);
                    console.log(`Base 50 ft‑obstacle (Lo): ${this.base_lo.obstacle} m`);

                    // 2) Density‑altitude effects -----------------------------------------
                    const elevation_m   = this.elevation_ft * 0.3048;
                    const lt_groundRoll = this.interpolate(this.temperature_c, this.tempData,      1);
                    const lt_obstacle   = this.interpolate(this.temperature_c, this.tempData,      2);
                    const lh_groundRoll = this.interpolate(elevation_m,         this.elevationData, 1);
                    const lh_obstacle   = this.interpolate(elevation_m,         this.elevationData, 2);

                    this.breakdown.tempEffect_Lt_groundRoll   = lt_groundRoll;
                    this.breakdown.tempEffect_Lt_obstacle     = lt_obstacle;
                    this.breakdown.elevationEffect_Lh_groundRoll = lh_groundRoll;
                    this.breakdown.elevationEffect_Lh_obstacle   = lh_obstacle;

                    console.log(`Temp effect on ground‑roll (Lt):   ${lt_groundRoll.toFixed(1)} m`);
                    console.log(`Temp effect on 50 ft (Lt):         ${lt_obstacle.toFixed(1)} m`);
                    console.log(`Elev. effect on ground‑roll (Lh):  ${lh_groundRoll.toFixed(1)} m`);
                    console.log(`Elev. effect on 50 ft (Lh):        ${lh_obstacle.toFixed(1)} m`);

                    // Combine ISA corrections
                    let combined_groundRoll = lh_groundRoll + lt_groundRoll - this.base_lo.groundRoll;
                    let combined_obstacle   = lh_obstacle   + lt_obstacle   - this.base_lo.obstacle;

                    // 3) Safety margin -----------------------------------------------------
                    this.breakdown.safetyMargin = 1.10;   // +10 %
                    combined_groundRoll *= this.breakdown.safetyMargin;
                    combined_obstacle   *= this.breakdown.safetyMargin;
                    this.breakdown.subtotal_density_groundRoll = combined_groundRoll;
                    this.breakdown.subtotal_density_obstacle   = combined_obstacle;
                    console.log(`Subtotal after density (ground‑roll): ${combined_groundRoll.toFixed(1)} m`);
                    console.log(`Subtotal after density (50 ft):       ${combined_obstacle.toFixed(1)} m`);

                    // 4) Wind correction ---------------------------------------------------
                    this.breakdown.windFactor_m = 0;
                    if (this.wind_kts > 0) {
                        // Headwind reduces distance (rule of thumb –7.62 m per 3 kt)
                        this.breakdown.windFactor_m = -(this.wind_kts / 3) * 7.62;
                    } else if (this.wind_kts < 0) {
                        // Tailwind increases distance (rule of thumb +19.812 m per 3 kt)
                        this.breakdown.windFactor_m = -(this.wind_kts / 3) * 19.812;
                    }
                    console.log(`Wind factor: ${this.breakdown.windFactor_m.toFixed(1)} m (` +
                                `${this.wind_kts} kt)`);

                    // 5) Surface and cross‑wind factors -----------------------------------
                    this.breakdown.surfaceFactor   = this.runwaySurface === 'grass' ? 1.20 : 1.0;
                    this.breakdown.crosswindFactor = 1.0 + (Math.floor(this.crosswind_kts / 5) * 0.10);
                    console.log(`Surface factor (${this.runwaySurface}): ×${this.breakdown.surfaceFactor}`);
                    console.log(`Cross‑wind factor (${this.crosswind_kts} kt): ` +
                                `×${this.breakdown.crosswindFactor}`);

                    // 6) Final result ------------------------------------------------------
                    let final_groundRoll = (combined_groundRoll *
                                        this.breakdown.surfaceFactor *
                                        this.breakdown.crosswindFactor) +
                                        this.breakdown.windFactor_m;

                    let final_obstacle   = (combined_obstacle *
                                        this.breakdown.surfaceFactor *
                                        this.breakdown.crosswindFactor) +
                                        this.breakdown.windFactor_m;

                    this.results.groundRoll = Math.max(0, final_groundRoll);
                    this.results.obstacle   = Math.max(0, final_obstacle);

                    console.log(`FINAL ground‑roll: ${this.results.groundRoll.toFixed(1)} m`);
                    console.log(`FINAL 50 ft‑obstacle: ${this.results.obstacle.toFixed(1)} m`);
                    console.log('--- Calculation complete ------------------------------------------------');

                    // 7) Update UI graphic
                    this.updateGraphic();
                },
                updateGraphic() {
                    const maxDist = Math.max(this.results.obstacle, this.runwayLength_m) * 1.15;
                    if (maxDist > 0) {
                        this.graphic.groundRollPercent = (this.results.groundRoll / maxDist) * 100;
                        this.graphic.obstaclePercent = (this.results.obstacle / maxDist) * 100;
                        this.graphic.runwayEndPercent = (this.runwayLength_m / maxDist) * 100;
                    }
                    this.calculateRulerTicks(maxDist);
                },
                getNiceStep(range) {
                    const exponent = Math.floor(Math.log10(range));
                    const powerOf10 = Math.pow(10, exponent);
                    const magnitude = range / powerOf10;
                    if (magnitude < 2) return powerOf10 / 5;
                    if (magnitude < 5) return powerOf10 / 2;
                    return powerOf10;
                },
                calculateRulerTicks(maxDist) {
                    this.graphic.rulerTicks = [];
                    if (maxDist <= 0) return;
                    let maxDistUnits = this.units === 'metric' ? maxDist : maxDist / 0.3048;
                    const step = this.getNiceStep(maxDistUnits);
                    for (let i = step; i < maxDistUnits; i += step) {
                        const value_m = this.units === 'metric' ? i : i * 0.3048;
                        this.graphic.rulerTicks.push({
                            label: i.toFixed(0) + (this.units === 'metric' ? 'm' : 'ft'),
                            positionPercent: (value_m / maxDist) * 100,
                        });
                    }
                },
                format(valueInMeters) {
                    const value = this.units === 'metric' ? valueInMeters : valueInMeters / 0.3048;
                    const unit = this.units === 'metric' ? ' m' : ' ft';
                    return value.toFixed(0) + unit;
                }
            }
        }
    </script>
</body>
</html>
